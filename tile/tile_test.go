package tile

import (
	"fmt"
	"log"
	"net/http"
	"testing"

	"github.com/firststreet/firststreet-go/backend"
	"github.com/firststreet/firststreet-go/testutil"
	assert "github.com/stretchr/testify/require"
)

var testBackend = &backend.Backend{
	HTTPClient: &http.Client{},
}

func testHandler() http.HandlerFunc {
	return http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) {
		fmt.Fprintln(w, []byte{
			0x89, 0x50, 0x4e, 0x47, 0x0d, 0x0a, 0x1a, 0x0a, 0x00, 0x00, 0x00, 0x0d, 0x49, 0x48, 0x44, 0x52,
			0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x08, 0x03, 0x00, 0x00, 0x00, 0x28, 0xcb, 0x34,
			0xbb, 0x00, 0x00, 0x00, 0x06, 0x50, 0x4c, 0x54, 0x45, 0x00, 0x00, 0x00, 0x80, 0x80, 0x80, 0x92,
			0x69, 0xb9, 0x24, 0x00, 0x00, 0x00, 0x02, 0x74, 0x52, 0x4e, 0x53, 0x00, 0x80, 0x9b, 0x2b, 0x4e,
			0x18, 0x00, 0x00, 0x00, 0x0a, 0x49, 0x44, 0x41, 0x54, 0x08, 0xd7, 0x63, 0x60, 0x00, 0x00, 0x00,
			0x02, 0x00, 0x01, 0xe2, 0x21, 0xbc, 0x33, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4e, 0x44, 0xae,
			0x42, 0x60, 0x82,
		})
	})
}

func TestGetPropertyByID(t *testing.T) {
	testutil.Once.Do(func() {
		testutil.StartServer(testHandler())
	})
	testBackend.URL = testutil.ServerAddr

	c := &Client{
		B:   testBackend,
		Key: "test",
	}
	//http://apidev.firststreet.org/tile/1.0/hurricane/12/1132/1744?key=VpqgUoepulokFjdxZvE4iMjP8bTtN2PG&type=kt&year=2018
	hurricaneTile, err := c.Hurricane(12, 1132, 1744, FloodType("c3"), 2018)
	assert.Nil(t, err)
	assert.NotNil(t, hurricaneTile)

	log.Println(hurricaneTile)

	// property, err = c.GetPropertyByLatLng(39.4419892114799, -75.6453718684964)
	// assert.Nil(t, err)
	// assert.NotNil(t, property)
}
